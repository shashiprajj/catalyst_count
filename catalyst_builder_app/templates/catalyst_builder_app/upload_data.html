{% extends 'catalyst_builder_app/base.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Upload Data</h2>
        <form id="upload-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.file.label_tag }} {{ form.file }}
            <button type="submit" class="btn btn-primary">Start Upload</button>
        </form>
        <div id="progress-container" class="mt-3" style="display:none;">
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
        {% if uploaded_files %}
        <h3 class="mt-5">Uploaded Files</h3>
        <ul>
            {% for file in uploaded_files %}
                <li>{{ file.file.name }} (Uploaded at: {{ file.uploaded_at }})</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function() {
    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        var percentComplete = e.loaded / e.total * 100;
                        $('#progress-container').show();
                        $('#progress-bar').css('width', percentComplete + '%');
                        $('#progress-bar').attr('aria-valuenow', percentComplete);
                    }
                }, false);
                return xhr;
            },
            type: 'POST',
            url: "{% url 'upload_data' %}",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    alert('File uploaded successfully!');
                    $('#progress-container').hide();
                    $('#progress-bar').css('width', '0%');
                    $('#progress-bar').attr('aria-valuenow', '0');
                    location.reload();  // Refresh the page to show the new file in the list
                }
            },
            error: function(response) {
                alert('An error occurred while uploading the file.');
            }
        });
    });
});
</script>
{% endblock %}
